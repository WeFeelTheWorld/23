(function(){
    "use strict";

    angular.module('app.controllers').controller('IndexCheckCtrl', function($rootScope, toastr, DialogService, DataService, IndexService){
        //
        //$rootScope.sidebarOpen = false;

        var vm = this;
        vm.data = IndexService.getData();
        vm.meta = IndexService.getMeta();
        vm.errors = IndexService.getErrors();
        vm.selected = [];
        
        vm.deleteData = deleteData;
        vm.deleteSelected = deleteSelected;
        vm.onOrderChange = onOrderChange;
        vm.onPaginationChange = onPaginationChange;
        vm.checkForErrors = checkForErrors;

        vm.showUploadContainer = false;
        vm.editColumnData = editColumnData;
        vm.editRow = editRow;

        vm.query = {
          filter: '',
          order: '-errors',
          limit: 15,
          page: 1
        };
        vm.myData = DataService.getAll('me/data');
        activate();

        function activate(){
          checkMyData();
        }

        function checkMyData(){
          vm.extendingChoices = [];
          if(vm.data.length){
            vm.myData.then(function(imports){
              angular.forEach(imports, function(entry){
                var found = 0;
                angular.forEach(vm.data[0].meta.fields, function(field){
                    var columns = JSON.parse(entry.meta_data);
                    angular.forEach(columns, function(column){
                      if(column.column == field ){
                        found++;
                      }
                    })
                });
                if(found >= vm.data[0].meta.fields.length - 2){
                  vm.extendingChoices.push(entry);
                }
              })
              if(vm.extendingChoices.length){
                DialogService.fromTemplate('extendData', $scope);
              }
            });
          }
        }
        function search(predicate) {
          vm.filter = predicate;
        };
        function onOrderChange(order) {
          return vm.data = $filter('orderBy')(vm.data, [order], true)
        };
        function onPaginationChange(page, limit) {
          //console.log(page, limit);
          //return $nutrition.desserts.get($scope.query, success).$promise;
        };
        function checkForErrors(item){
          return item.errors.length > 0 ? 'md-warn': '';
        }

        function editColumnData(e, key){
          vm.toEdit = key;
          DialogService.fromTemplate('editcolumn', $scope);
        }
        function deleteSelected(){
          angular.forEach(vm.selected, function(item, key){
            angular.forEach(item.errors, function(error, k){
              if(error.type == 2){
                vm.iso_errors --;
              }
              vm.errors --;
            })
            vm.data.splice(vm.data.indexOf(item), 1);
            vm.selected.splice(key, 1);
          });
          if(vm.data.length == 0){
            vm.deleteData();
            $state.got('app.index.create');
          }
        }
        function editRow(){
          vm.row = vm.selected[0];
          DialogService.fromTemplate('editrow', $scope);
        }
        function deleteData(){
          vm.data = [];
        }

    });

})();
