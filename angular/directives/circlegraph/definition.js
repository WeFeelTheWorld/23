(function() {
	"use strict";

	angular.module('app.directives').directive('circlegraph', function($timeout) {
		var defaults = function() {
			return {
				width: 80,
				height: 80,
				color: '#00ccaa',
				size: 178
			}
		}
		return {
			restrict: 'E',
			controller: 'CirclegraphCtrl',
			scope: true,
			require: 'ngModel',
			link: function($scope, element, $attrs, ngModel) {
				//Fetching Options
				var options = angular.extend(defaults(), $attrs);

				//Creating the Scale
				var rotate = d3.scale.linear()
					.domain([1, options.size])
					.range([1, 0])
					.clamp(true);

				//Creating Elements
				var svg = d3.select(element[0]).append('svg')
					.attr('width', options.width)
					.attr('height', options.height)
					.append('g');
				var container = svg.append('g')
					.attr('transform', 'translate(' + options.width / 2 + ',' + options.height / 2 + ')');
				var circleBack = container.append('circle')
					.attr('r', options.width / 2 - 2)
					.attr('stroke-width', 2)
					.attr('stroke', options.color)
					.style('opacity', '0.6')
					.attr('fill', 'none');
				var arc = d3.svg.arc()
					.startAngle(0)
					.innerRadius(function(d) {
						return options.width / 2 - 4;
					})
					.outerRadius(function(d) {
						return options.width / 2;
					});
				var circleGraph = container.append('path')
					.datum({
						endAngle: 2 * Math.PI * 0
					})
					.style("fill", options.color)
					.attr('d', arc);
				var text = container.selectAll('text')
					.data([0])
					.enter()
					.append('text')
					.text(function(d) {
						return d + '/' + options.size;
					})
					.attr('text-anchor', 'middle')
					.attr('y', '0.35em');

				//Transition if selection has changed
				function animateIt(radius) {
					circleGraph.transition()
						.duration(750)
						.call(arcTween, rotate(radius) * 2 * Math.PI);
					text.transition().duration(750).tween('text', function(d) {
						var data = this.textContent.split("/");
						var i = d3.interpolate(data[0], radius);
						return function(t) {
							this.textContent = (Math.round(i(t) * 1) / 1) + '/' + options.size;
						};
					})
				}

				//Tween animation for the Arc
				function arcTween(transition, newAngle) {
					transition.attrTween("d", function(d) {
						var interpolate = d3.interpolate(d.endAngle, newAngle);
						return function(t) {
							d.endAngle = interpolate(t);
							return arc(d);
						};
					});
				}

				//Watching if selection has changed from another UI element
				$scope.$watch(
					function() {
						return ngModel.$modelValue;
					},
					function(newValue, oldValue) {
						if (!newValue){
							newValue = {
								rank: options.size
							};
						}

						$timeout(function(){
							animateIt(newValue.rank)
						});

					});
			}
		};

	});

})();
